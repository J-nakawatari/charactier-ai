## 🧠 キャラクター性格プロンプトの設計

* 各キャラクターは `systemPrompt` を保持し、チャットセッション開始時（初回リクエスト時）のみに送信する。
* 以降は `CharacterPromptCache` にキャッシュされ、APIリクエストには含めない。
* この設計によりトークン使用量（コスト）を削減。
* 関連モデル:

  * `Character.js`
  * `CharacterPromptCache.js`
  * `characterPrompt.js`（ルート）

---

## 💰 トークン付与と利益設計（50%利益確保）

* ユーザーが支払った金額（例: 500円）に対して、OpenAI APIやStripe手数料などのコストを除外した上で、システム側に約50%の利益が残るようにトークン数を設計。
* `TokenPack` モデルには以下を定義：

  * `purchaseAmountYen`: 購入金額
  * `tokensPurchased`: 付与トークン数
  * `maxCostYen`: 利用可能最大コスト
* トークンの消費記録は `TokenUsage.js` に記録され、ユーザーごとの残高は `UserTokenPack.js` で管理。
* 過去のチャージユーザーは `resetToTokenSystem.js` により変換対応済み。

---

## 🔐 セキュリティ・レート制限・エラーログ設計

* `rateLimitSecurity.js` にて、APIアクセスのIPベースのレートリミットを実装。
* `errorLogger.js` にて、Expressアプリ内の全エラーをフックしてDBへ記録。
* `SecurityEvent.js`, `ViolationRecord.js` により、不正検出ログ・制限ログを記録。
* これらは管理者画面から可視化予定（未実装であれば今後対応）。

---

## 📘 サービス概要（Claude Code向け）

* 初回登録ユーザーには仮で 100,000 トークンを無料付与。
* トークンを使い切った後は、追加購入によりチャット継続が可能。
* 初期キャラは約2体を想定。他のキャラ（個性・外見の異なる複数体）は課金によってアンロック。
* キャラのアンロックはトークンと別の"開放課金"で行い、アンロック後もチャットにはトークンを消費。
* ✅ **本サービスは完全レスポンシブ対応（スマホ・PC・タブレット）である必要がある**
🌍 多言語対応（i18n）について：
- ユーザー向け画面のみ Next.js の多言語ルーティング（`/app/[locale]/`）に対応
- 管理画面は多言語対応 **不要（日本語のみ）**
> YOU MUST: サイトはすべての画面幅（モバイル / タブレット / デスクトップ）で正しく表示されること  
> YOU MUST: Next.jsの`/app/[locale]/`構成に基づく国際化（i18n）に完全対応すること  


### 🔓 親密度システム

* 各キャラとの会話により親密度が上昇。
* 親密度レベルは最大100、10レベルごとにイラストが1枚解放（最大10枚）。
* 親密度の上昇により会話スタイルが段階的に変化（例：口調やリアクションが変わる）。

### 🛠 管理画面とユーザー画面

* 管理画面ではキャラ作成・編集時に：

  * プルダウンで"性格タイプ"を選択
  * チェックボックスで特徴を複数選択
* ユーザー画面ではチャット、親密度、トークン残高、キャラロック状況を表示。

### 🧭 UI設計

* 共通の左サイドメニュー / 右コンテンツレイアウト。
* トースト通知による操作結果表示（成功・失敗・警告など）。
* パスワード変更、メールアドレス変更にも対応。
* 管理画面トップでは：

  * ユーザー数、アクティブ率、キャラ利用数、APIエラーなどをチャート表示。
  * 問題がある要素は即時視認可能（セキュリティイベント・DBエラー等）。
* ダッシュボード型の洗練されたUIを目指す。

  * 白を基調としたフラットデザイン
  * シンプルなアイコン（Lucideなど）
  * ボタンやリンクは明確にクリック可能に設計
  * CSSフレームワーク（Tailwindなど）の使用可

---

## 📌 補足要素（セキュリティ・運用拡張性）

### 1. ✅ ユーザー登録・認証の仕様

* JWT認証を前提とし、`accessToken` + `refreshToken` 構成での安全な認証を実装。
* 将来的にはメール認証やSNSログイン（Google, Apple等）も導入可能な設計を意識。

### 2. ✅ Stripe Webhookの失敗処理

* Stripeの決済Webhookが失敗・重複した場合のために冪等性処理（idempotency key）を導入。
* Webhook受信時は `event.id` による一意判定を行い、同一処理の二重実行を防ぐ。
* トライアルユーザーのトークン切れ時は警告表示し、購入導線をモーダル表示。

### 3. ✅ API利用量の可視化

* 管理画面から任意ユーザーのトークン使用状況（月次 / 累計）を表示可能にする。
* 使用履歴は `TokenUsage.js` から集計し、チャート等でグラフィカルに表示。

### 4. ✅ メルマガ・通知設計

* キャラからの通知メッセージ（ex: "会いに来て！"）を親密度に応じて配信。
* 通知種別：トークン残量警告 / イラストアンロック通知 / メンテナンス告知など。
* 配信方式：フロント内通知 + 管理画面から一斉通知を制御。
